<view class="container">
  <!-- 背景图片组：实现渐变切换 -->
  <view class="bg-group">
    <!-- 初始背景 (0.webp) 始终显示在最底层 -->
    <image class="bg-img" src="./images/0.webp" mode="aspectFill"></image>
    
    <!-- 步骤1完成后的背景 (1-0, 1-1, 1-2 依次显示) -->
    <image class="bg-img {{ currentImageIndex >= 1 ? 'visible' : ''}}" src="./images/1-0.webp" mode="aspectFill"></image>
    <image class="bg-img {{ currentImageIndex >= 2 ? 'visible' : ''}}" src="./images/1-1.webp" mode="aspectFill"></image>
    <image class="bg-img {{ currentImageIndex >= 3 ? 'visible' : ''}}" src="./images/1-2.webp" mode="aspectFill"></image>
    
    <!-- 步骤2完成后的背景 (2.webp) -->
    <image class="bg-img {{ currentImageIndex >= 4 ? 'visible' : ''}}" src="./images/2.webp" mode="aspectFill"></image>
    
    <!-- 步骤3完成后的背景 (3.webp) -->
    <image class="bg-img {{ currentImageIndex >= 5 ? 'visible' : ''}}" src="./images/3.webp" mode="aspectFill"></image>
    
    <!-- 步骤4完成后的背景 (4-0, 4-1 依次显示) -->
    <image class="bg-img {{ currentImageIndex >= 6 ? 'visible' : ''}}" src="./images/4-0.webp" mode="aspectFill"></image>
    <image class="bg-img {{ currentImageIndex >= 7 || gameState === 'success' ? 'visible' : ''}}" src="./images/4-1.webp" mode="aspectFill"></image>
  </view>

  <!-- 氛围滤镜层 -->
  <view class="mood-overlay {{moodClass}}"></view>

  <!-- 悬浮粒子系统 -->
  <view class="particles-container">
    <view class="particle" wx:for="{{30}}" wx:key="index"></view>
  </view>

  <!-- 飞入动画的临时图标 -->
  <image 
    wx:if="{{flyingItem}}" 
    class="flying-item" 
    src="{{flyingItem.src}}" 
    style="left: {{flyingItem.x}}px; top: {{flyingItem.y}}px;"
    mode="aspectFit"
  ></image>

  <!-- 顶部操作栏 (横向滚动) - 只在 showing 和 playing 状态显示 -->
  <view class="top-action-bar" wx:if="{{gameState === 'showing' || gameState === 'playing'}}">
    <view class="action-scroll-wrapper">
      <view class="action-list">
        <view 
          wx:for="{{items}}" 
          wx:key="id" 
          class="action-btn-item {{currentHighlightId === item.id ? 'highlight' : ''}} {{item.isEquipped ? 'completed' : ''}}"
          bindtap="onItemClick" 
          data-id="{{item.id}}"
        >
          <image class="action-icon" src="{{item.icon}}" mode="aspectFit"></image>
          <!-- 粒子爆发 (仅在完成时显示) -->
          <view class="burst-particles" wx:if="{{item.isEquipped}}">
            <view class="burst-p" wx:for="{{8}}" wx:key="index"></view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 返回按钮 (左上角) -->
  <view class="back-btn" bindtap="goBack">
    <text class="back-arrow">❮</text>
  </view>

  <!-- 计时器 (右上角) - 只在 playing 状态显示 -->
  <view class="timer-container {{timeLeft <= 30 ? 'urgent' : ''}}" wx:if="{{gameState === 'playing'}}">
    <view class="timer-circle">
      <text class="timer-num">{{timeLeft}}</text>
    </view>
  </view>

  <!-- 指引文字 (底部) - 只在 showing 和 playing 状态显示 -->
  <view class="instruction-area" wx:if="{{gameState === 'showing' || gameState === 'playing'}}">
    <view class="instruction-box">
      <text class="instruction-text">{{instructionText}}</text>
    </view>
  </view>

  <!-- 弹窗 - 只在 start, success, fail 状态显示 -->
  <view class="overlay" wx:if="{{gameState === 'start' || gameState === 'success' || gameState === 'fail'}}">
    <view class="modal {{gameState}}">
      <block wx:if="{{gameState === 'start'}}">
        <view class="modal-title">恭请大哑巴</view>
        <view class="modal-content">
          彝族祭祀仪式即将开始。\n请按照传统习俗的正确顺序，为"大哑巴"穿戴法衣法器，切勿乱了规矩。
        </view>
        <button class="start-btn" bindtap="startGame">开始装扮</button>
      </block>

      <block wx:elif="{{gameState === 'success'}}">
        <view class="modal-title">大哑巴准备就绪！</view>
        <view class="modal-content">
          仪式正式开始\n\n大哑巴身绘龙纹祈雨，头戴牛角象征力量，羽饰展现神圣，手持法器驱邪。在火把节中，他将带领人们祈求来年风调雨顺。
        </view>
        <text class="culture-text">祭祀是庄重之事，每一个步骤都有其深刻含义</text>
        <button class="start-btn" bindtap="startGame">再来一次</button>
      </block>

      <block wx:elif="{{gameState === 'fail'}}">
        <view class="modal-title">仪式准备未完成</view>
        <view class="modal-content">
          时间耗尽或顺序有误。\n祭祀是庄重之事，请静下心来再试一次。
        </view>
        <button class="start-btn" bindtap="startGame">重新开始</button>
      </block>
    </view>
  </view>
</view>
