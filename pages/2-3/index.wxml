<view class="container" bindtap="handleTap">
  <!-- 全局返回按钮 -->
  <view class="back-btn-global" catchtap="goBack">
    <text>← 返回</text>
  </view>

  <!-- 背景层 -->
  <view class="bg-layer">
    <image class="bg-image" src="{{gameState === 'opening' || gameState === 'puzzle' ? '/pages/2-3/images/1未开启的大门.webp' : (gameState === 'blessing' ? (showBlessingSuccessBG ? '/pages/2-3/images/4屋子被成功纳福.webp' : '/pages/2-3/images/3雾气散去后的屋子.webp') : (gameState === 'farewell' ? (farewellState === 'yard_gift' || farewellState === 'finished' ? '/pages/2-3/images/6村民送来礼物后.webp' : '/pages/2-3/images/5院子视角，空无一物.webp') : '/pages/2-3/images/2门已开启，屋内被雾气笼罩.webp'))}}" mode="aspectFill"></image>
    <view class="bg-overlay"></view>
  </view>

  <!-- 内容层 -->
  <view class="content-layer" wx:if="{{gameState === 'opening'}}">
    <view class="text-container">
      <text class="opening-text line-1">大哑巴今日入户送吉</text>
      <text class="opening-text line-2">请随他完成驱邪与纳福之礼</text>
      
      <view class="divider"></view>
      
      <text class="opening-text line-3">仪式开始</text>
      <text class="opening-text line-4">愿你的脚步带来山风般的祝福</text>
    </view>

    <view class="start-prompt">
      <text class="prompt-text">点击屏幕开启仪式</text>
      <view class="prompt-icon">👆</view>
    </view>
  </view>

  <!-- 解谜层 (拼图) -->
  <view class="puzzle-layer" wx:if="{{gameState === 'puzzle'}}">
    <view class="puzzle-header">
      <text class="puzzle-title">入门解谜</text>
      <text class="puzzle-subtitle">完成拼图，还原大门</text>
    </view>

    <view class="puzzle-container">
      <view 
        class="puzzle-piece {{selectedPiece === index ? 'selected' : ''}} {{item.isCorrect ? 'correct' : ''}}" 
        wx:for="{{puzzlePieces}}" 
        wx:key="id"
        style="left: {{item.x * 200}}rpx; top: {{item.y * 200}}rpx; background-position: -{{item.origX * 200}}rpx -{{item.origY * 200}}rpx;"
        bindtap="handlePieceTap"
        data-index="{{index}}"
      ></view>
    </view>

    <!-- 帮助按钮 -->
    <view class="help-btn" bindtap="autoSolvePuzzle">
      <text>有困难，请大哑巴帮忙开门</text>
    </view>

    <!-- 成功提示 -->
    <view class="success-overlay" wx:if="{{isPuzzleSolved}}">
      <text class="success-text">门已应声而开</text>
      <text class="success-subtext">欢迎步入这户人家</text>
    </view>
  </view>

  <!-- 阶段三：驱邪仪式 (节奏游戏) -->
  <view class="rhythm-layer" wx:if="{{gameState === 'rhythm'}}">
    <!-- 游戏指引遮罩 -->
    <view class="guide-overlay" wx:if="{{showRhythmGuide}}" bindtap="startRhythmGame">
      <view class="guide-content">
        <text class="guide-title">驱邪仪式</text>
        <text class="guide-desc">跟随鼓点，点击亮起的法器</text>
        <text class="guide-sub">驱除邪祟，护佑平安</text>
        <view class="guide-btn">点击开始</view>
      </view>
    </view>

    <!-- 游戏区域 -->
    <view class="game-area" wx:else>
      <view class="score-board">
        <text>得分: {{currentScore}}</text>
      </view>

      <view class="instruments-container">
        <view 
          class="instrument {{activeInstrument === 'bell' ? 'active' : ''}}" 
          bindtap="handleInstrumentTap" 
          data-type="bell"
        >
          <image src="/pages/2-3/images/法铃.webp" mode="aspectFit"></image>
        </view>
        <view 
          class="instrument {{activeInstrument === 'mortar' ? 'active' : ''}}" 
          bindtap="handleInstrumentTap" 
          data-type="mortar"
        >
          <image src="/pages/2-3/images/小研臼.webp" mode="aspectFit"></image>
        </view>
        <view 
          class="instrument {{activeInstrument === 'willow' ? 'active' : ''}}" 
          bindtap="handleInstrumentTap" 
          data-type="willow"
        >
          <image src="/pages/2-3/images/柳枝.webp" mode="aspectFit"></image>
        </view>
      </view>

      <!-- 反馈动画 -->
      <view class="feedback-popup" wx:if="{{feedbackText}}" style="left: {{feedbackPos.x}}px; top: {{feedbackPos.y}}px">
        <text class="feedback-text {{feedbackClass}}">{{feedbackText}}</text>
      </view>

      <!-- 点击飞出动画 -->
      <view class="flying-icons">
        <image 
          wx:for="{{flyingIcons}}" 
          wx:key="id"
          src="{{item.src}}" 
          class="flying-icon"
          style="left: {{item.x}}px; top: {{item.y}}px;"
        ></image>
      </view>
    </view>
  </view>

  <!-- 阶段四：结算页面 -->
  <view class="ending-layer" wx:if="{{gameState === 'ending'}}">
    <view class="ending-content">
      <!-- 标题区域 -->
      <view class="ending-header">
        <text class="ending-title">{{endingTitle}}</text>
        <text class="ending-subtitle">{{endingSubtitle}}</text>
      </view>

      <!-- 分数展示 -->
      <view class="score-display">
        <view class="score-circle">
          <text class="score-number">{{endingScore}}</text>
          <text class="score-label">得分</text>
        </view>
        <view class="grade-badge grade-{{endingGrade}}">
          <text class="grade-text">{{endingGrade}}</text>
        </view>
      </view>

      <!-- 评语 -->
      <view class="ending-message-box">
        <text class="ending-message">{{endingMessage}}</text>
      </view>

      <!-- 装饰分割线 -->
      <view class="ending-divider">
        <view class="divider-line"></view>
        <view class="divider-icon">✨</view>
        <view class="divider-line"></view>
      </view>

      <!-- 按钮区域 -->
      <view class="ending-buttons">
        <view class="btn-next" bindtap="goToNextPhase">
          <text>进入下一阶段</text>
          <text class="btn-arrow">→</text>
        </view>
        <view class="btn-restart" bindtap="restartGame">
          <text>重新挑战</text>
        </view>
      </view>

      <!-- 底部装饰 -->
      <view class="ending-footer">
        <text class="footer-text">驱邪仪式已完成</text>
      </view>
    </view>
  </view>

  <!-- 阶段五：纳福阶段 -->
  <view class="blessing-layer" wx:if="{{gameState === 'blessing'}}">
    <!-- 提示框 -->
    <view class="blessing-prompt-box {{isBlessingTime ? 'show' : ''}}">
      <text class="blessing-title">{{blessingPrompt.title}}</text>
      <text class="blessing-desc">{{blessingPrompt.desc}}</text>
    </view>

    <!-- 结果反馈 -->
    <view class="blessing-result-overlay" wx:if="{{showBlessingResult}}">
      <text class="blessing-result-text">{{blessingResultText}}</text>
    </view>

    <!-- 互动区域 -->
    <view class="blessing-targets">
      <!-- 灶台 -->
      <view class="target-area target-stove" bindtap="handleBlessingTap" data-type="stove">
        <!-- 只有在正确时或者特定状态下才可能显示高亮图标，或者一直显示 subtle 图标 -->
        <!-- 根据需求"玩家需点击正确对象"，这里放透明点击区，可以加一点微弱提示 -->
        <image class="target-icon" src="/pages/2-3/images/火柴.webp" mode="aspectFit"></image>
      </view>

      <!-- 粮袋/谷仓 -->
      <view class="target-area target-grain" bindtap="handleBlessingTap" data-type="grain">
        <image class="target-icon" src="/pages/2-3/images/粮食.webp" mode="aspectFit"></image>
      </view>

      <!-- 门框/梁柱 -->
      <view class="target-area target-pillar" bindtap="handleBlessingTap" data-type="pillar">
        <image class="target-icon" src="/pages/2-3/images/红丝带.webp" mode="aspectFit"></image>
      </view>
    </view>

    <!-- 纳福进度 -->
    <view class="blessing-progress">
      <text>纳福进度: {{blessingScore}} / 3</text>
    </view>
  </view>

  <!-- 阶段六：告别收礼 -->
  <view class="farewell-layer" wx:if="{{gameState === 'farewell'}}">
    <!-- 最终文案 -->
    <view class="final-message-box" wx:if="{{farewellState === 'finished'}}">
      <text class="final-message-text">吉祥已送达，\n愿下一户更添喜气。</text>
      
      <!-- 结局操作按钮 -->
      <view class="final-actions">
        <view class="action-btn restart" catchtap="restartGame">再来一次</view>
        <view class="action-btn back" catchtap="goBack">返回首页</view>
      </view>
    </view>
  </view>
</view>
